{% extends "base.html" %}

{% block title %}Tasks - Cyclonetix{% endblock title %}

{% block head %}{% endblock head %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-1">
        <h2>Task Templates</h2>
    </div>

    <div class="card task-table">
        <div class="table-responsive">
            <div id="tasks-table"></div> <!-- Tabulator container -->
        </div>
    </div>
</div>

<!-- Schedule Task Modal -->
<div class="modal" id="scheduleTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="scheduleTaskForm">
                    <input type="hidden" id="taskId" name="taskId">
                    <div class="mb-3">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Environment Variables</label>
                        <div id="envVars">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Key" name="envKey[]">
                                <input type="text" class="form-control" placeholder="Value" name="envValue[]">
                                <button type="button" class="btn btn-outline-danger" onclick="removeEnvVar(this)">×</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addEnvVar()">
                            Add Environment Variable
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scheduleTask()">Schedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<!-- Include Tabulator JS -->
<script src="/static/js/tabulator.js"></script>

<script>
    let modal;

    document.addEventListener('DOMContentLoaded', function() {
        let modalElement = document.getElementById('scheduleTaskModal');
        if (modalElement) {
            modal = new bootstrap.Modal(modalElement);
        }
        loadTasksTable();
    });

    function showScheduleModal(taskId, taskName) {
        document.getElementById('taskId').value = taskId;
        document.getElementById('taskName').value = taskName;
        modal.show();
    }

    function loadTasksTable() {
        let table = new Tabulator("#tasks-table", {
            ajaxURL: "/api/tasks",  // Fetch task data from this endpoint
            layout: "fitColumns",
            pagination: "local",
            paginationSize: 10,
            responsiveLayout: "collapse",  // Adjusts for small screens
            headerSort: true,
            columns: [
                { title: "Name", field: "name", headerFilter: "input", headerSort: true },
                { title: "Description", field: "description", headerFilter: "input", headerSort: true },
                { title: "Command", field: "command", formatter: "plaintext" },
                { title: "Queue", field: "queue", formatter: "badge", formatterParams: { color: "blue" }},
                {
                    title: "Actions",
                    field: "id",
                    headerSort: false,
                    formatter: function(cell) {
                        let taskId = cell.getValue();
                        let taskName = cell.getRow().getData().name;
                        return `<button class="btn btn-primary btn-sm action-button" onclick="showScheduleModal('${taskId}', '${taskName}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-player-play" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M7 4v16l13 -8z"></path>
                                    </svg>
                                </button>`;
                    }
                }
            ]
        });

        applyTabulatorTheme(); // Ensure correct theme is applied
    }

    function addEnvVar() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
        <input type="text" class="form-control" placeholder="Key" name="envKey[]">
        <input type="text" class="form-control" placeholder="Value" name="envValue[]">
        <button type="button" class="btn btn-outline-danger" onclick="removeEnvVar(this)">×</button>
    `;
        document.getElementById('envVars').appendChild(div);
    }

    function removeEnvVar(button) {
        button.parentElement.remove();
    }

    function scheduleTask() {
        const taskId = document.getElementById('taskId').value;
        const envVars = Object.fromEntries(
            [...document.getElementsByName('envKey[]')].map((el, i) => [el.value, document.getElementsByName('envValue[]')[i].value]).filter(([k]) => k)
        );

        fetch('/api/schedule-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_id: taskId, env_vars: envVars })
        }).then(res => res.json()).then(data => {
            if (data.success) modal.hide();
            alert(data.success ? "Task scheduled successfully!" : `Error: ${data.error}`);
        }).catch(error => alert("Error scheduling task: " + error));
    }
</script>
{% endblock scripts %}
